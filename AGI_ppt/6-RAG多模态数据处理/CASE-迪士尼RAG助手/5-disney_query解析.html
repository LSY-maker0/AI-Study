<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¿ªå£«å°¼RAGåŠ©æ‰‹ä»£ç è§£æ</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 40px;
        }
        
        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 40px;
            font-size: 1.1em;
        }
        
        h2 {
            color: #764ba2;
            margin-top: 40px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
            font-size: 1.8em;
        }
        
        h3 {
            color: #555;
            margin-top: 30px;
            margin-bottom: 15px;
            font-size: 1.4em;
        }
        
        .section {
            margin-bottom: 40px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 5px solid #667eea;
        }
        
        .mermaid-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .code-block {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.5;
        }
        
        .code-block .line-num {
            color: #75715e;
            margin-right: 15px;
            user-select: none;
        }
        
        .variable-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .variable-table th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        
        .variable-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .variable-table tr:hover {
            background: #f5f5f5;
        }
        
        .variable-table .var-name {
            font-family: 'Courier New', monospace;
            color: #764ba2;
            font-weight: bold;
        }
        
        .variable-table .var-type {
            color: #666;
            font-style: italic;
        }
        
        .flow-step {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .flow-step h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.2em;
        }
        
        .function-box {
            background: #fff;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .function-box h4 {
            color: #764ba2;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .highlight {
            background: #fff3cd;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 500;
        }
        
        .note {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        .warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        ul, ol {
            margin-left: 30px;
            margin-top: 10px;
        }
        
        li {
            margin: 8px 0;
        }
        
        .data-structure {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¢ è¿ªå£«å°¼RAGåŠ©æ‰‹ä»£ç è§£æ</h1>
        <p class="subtitle">RAGå¤šæ¨¡æ€æ•°æ®å¤„ç† - æŸ¥è¯¢å¤„ç†æ¨¡å—è¯¦ç»†åˆ†æ</p>
        
        <!-- æ•´ä½“æµç¨‹ -->
        <div class="section">
            <h2>ğŸ“Š æ•´ä½“æµç¨‹å›¾</h2>
            <div class="mermaid-container">
                <div class="mermaid">
graph TD
    A[å¼€å§‹: ç”¨æˆ·è¾“å…¥Query] --> B[åŠ è½½ç´¢å¼•å’Œå…ƒæ•°æ®]
    B --> C[è·å–Queryçš„Embeddingå‘é‡]
    C --> D[åœ¨FAISSç´¢å¼•ä¸­æœç´¢æ‰€æœ‰ç›¸ä¼¼å†…å®¹]
    D --> E[è®¡ç®—ç›¸ä¼¼åº¦å¹¶æ’åº]
    E --> F[æ£€æµ‹åª’ä½“æ„å›¾<br/>å›¾ç‰‡/è§†é¢‘å…³é”®è¯]
    F --> G{éœ€è¦å›¾ç‰‡?}
    F --> H{éœ€è¦è§†é¢‘?}
    G -->|æ˜¯| I[ç­›é€‰è·ç¦»&lt;3çš„å›¾ç‰‡<br/>å–è·ç¦»æœ€å°çš„Top1]
    G -->|å¦| J[è·³è¿‡å›¾ç‰‡åŒ¹é…]
    H -->|æ˜¯| K[ç­›é€‰è·ç¦»&lt;3çš„è§†é¢‘<br/>å–è·ç¦»æœ€å°çš„Top1]
    H -->|å¦| L[è·³è¿‡è§†é¢‘åŒ¹é…]
    I --> M[é€‰æ‹©Top-Kæ–‡æœ¬ç»“æœ]
    J --> M
    K --> M
    L --> M
    M --> N[æ„å»ºPromptä¸Šä¸‹æ–‡]
    N --> O[è°ƒç”¨LLMç”Ÿæˆç­”æ¡ˆ]
    O --> P[é™„åŠ åŒ¹é…çš„å›¾ç‰‡/è§†é¢‘]
    P --> Q[è¿”å›æœ€ç»ˆç­”æ¡ˆ]
    
    style A fill:#667eea,stroke:#333,stroke-width:2px,color:#fff
    style Q fill:#764ba2,stroke:#333,stroke-width:2px,color:#fff
    style F fill:#ffc107,stroke:#333,stroke-width:2px
    style O fill:#4caf50,stroke:#333,stroke-width:2px,color:#fff
                </div>
            </div>
        </div>
        
        <!-- é…ç½®å˜é‡ -->
        <div class="section">
            <h2>âš™ï¸ é…ç½®å˜é‡è¯´æ˜</h2>
            <table class="variable-table">
                <thead>
                    <tr>
                        <th>å˜é‡å</th>
                        <th>ç±»å‹</th>
                        <th>å«ä¹‰</th>
                        <th>ä»£ç ä½ç½®</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="var-name">DASHSCOPE_API_KEY</td>
                        <td class="var-type">str</td>
                        <td>é˜¿é‡Œäº‘DashScope APIå¯†é’¥ï¼Œä»ç¯å¢ƒå˜é‡è·å–</td>
                        <td>16è¡Œ</td>
                    </tr>
                    <tr>
                        <td class="var-name">client</td>
                        <td class="var-type">OpenAI</td>
                        <td>OpenAIå…¼å®¹å®¢æˆ·ç«¯ï¼Œç”¨äºè°ƒç”¨LLM API</td>
                        <td>22-25è¡Œ</td>
                    </tr>
                    <tr>
                        <td class="var-name">MULTIMODAL_EMBEDDING_MODEL</td>
                        <td class="var-type">str</td>
                        <td>å¤šæ¨¡æ€åµŒå…¥æ¨¡å‹åç§°ï¼š"tongyi-embedding-vision-plus"</td>
                        <td>27è¡Œ</td>
                    </tr>
                    <tr>
                        <td class="var-name">INDEX_FILE</td>
                        <td class="var-type">str</td>
                        <td>FAISSç´¢å¼•æ–‡ä»¶è·¯å¾„ï¼š"disney_index.faiss"</td>
                        <td>28è¡Œ</td>
                    </tr>
                    <tr>
                        <td class="var-name">METADATA_FILE</td>
                        <td class="var-type">str</td>
                        <td>å…ƒæ•°æ®JSONæ–‡ä»¶è·¯å¾„ï¼š"disney_metadata.json"</td>
                        <td>29è¡Œ</td>
                    </tr>
                    <tr>
                        <td class="var-name">IMAGE_KEYWORDS</td>
                        <td class="var-type">list[str]</td>
                        <td>å›¾ç‰‡æ„å›¾å…³é”®è¯åˆ—è¡¨ï¼š["å›¾ç‰‡", "æµ·æŠ¥", "ç…§ç‰‡", "çœ‹çœ‹", "é•¿ä»€ä¹ˆæ ·", "å›¾"]</td>
                        <td>32è¡Œ</td>
                    </tr>
                    <tr>
                        <td class="var-name">VIDEO_KEYWORDS</td>
                        <td class="var-type">list[str]</td>
                        <td>è§†é¢‘æ„å›¾å…³é”®è¯åˆ—è¡¨ï¼š["è§†é¢‘", "å½•åƒ", "å½±ç‰‡", "çœ‹ä¸€ä¸‹", "æ’­æ”¾"]</td>
                        <td>33è¡Œ</td>
                    </tr>
                    <tr>
                        <td class="var-name">MEDIA_DISTANCE_THRESHOLD</td>
                        <td class="var-type">float</td>
                        <td>åª’ä½“åŒ¹é…çš„è·ç¦»é˜ˆå€¼ï¼š3.0ï¼ˆè·ç¦»å°äºæ­¤å€¼æ‰åŒ¹é…ï¼‰</td>
                        <td>34è¡Œ</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- æ ¸å¿ƒå‡½æ•°è¯¦è§£ -->
        <div class="section">
            <h2>ğŸ”§ æ ¸å¿ƒå‡½æ•°è¯¦è§£</h2>
            
            <!-- load_index -->
            <div class="function-box">
                <h4>1. load_index() - åŠ è½½ç´¢å¼•å’Œå…ƒæ•°æ®</h4>
                <div class="code-block">
<span class="line-num">37-43</span>def load_index():
    """åŠ è½½ç´¢å¼•å’Œå…ƒæ•°æ®"""
    index = faiss.read_index(INDEX_FILE)
    with open(METADATA_FILE, 'r', encoding='utf-8') as f:
        metadata = json.load(f)
    print(f"å·²åŠ è½½ç´¢å¼•: {index.ntotal} æ¡è®°å½•")
    return index, metadata
                </div>
                <ul>
                    <li><strong>åŠŸèƒ½</strong>ï¼šä»ç£ç›˜åŠ è½½FAISSå‘é‡ç´¢å¼•å’Œå¯¹åº”çš„å…ƒæ•°æ®JSONæ–‡ä»¶</li>
                    <li><strong>è¿”å›å€¼</strong>ï¼š
                        <ul>
                            <li><span class="var-name">index</span>ï¼šFAISSç´¢å¼•å¯¹è±¡ï¼ŒåŒ…å«æ‰€æœ‰æ–‡æ¡£çš„å‘é‡</li>
                            <li><span class="var-name">metadata</span>ï¼šåˆ—è¡¨ï¼Œæ¯ä¸ªå…ƒç´ åŒ…å«ä¸€æ¡è®°å½•çš„å…ƒæ•°æ®ï¼ˆtype, content, source, path/urlç­‰ï¼‰</li>
                        </ul>
                    </li>
                    <li><strong>å…³é”®å˜é‡</strong>ï¼š
                        <ul>
                            <li><span class="var-name">index.ntotal</span>ï¼šç´¢å¼•ä¸­å‘é‡çš„æ€»æ•°</li>
                            <li><span class="var-name">metadata[idx]</span>ï¼šé€šè¿‡ç´¢å¼•IDè·å–å¯¹åº”çš„å…ƒæ•°æ®</li>
                        </ul>
                    </li>
                </ul>
            </div>
            
            <!-- get_text_embedding -->
            <div class="function-box">
                <h4>2. get_text_embedding(text) - è·å–æ–‡æœ¬åµŒå…¥å‘é‡</h4>
                <div class="code-block">
<span class="line-num">46-54</span>def get_text_embedding(text):
    """æ–‡æœ¬embedding"""
    resp = dashscope.MultiModalEmbedding.call(
        model=MULTIMODAL_EMBEDDING_MODEL,
        input=[{'text': text}]
    )
    if resp.status_code != HTTPStatus.OK:
        raise Exception(f"Embeddingå¤±è´¥: {resp.message}")
    return resp.output['embeddings'][0]['embedding']
                </div>
                <ul>
                    <li><strong>åŠŸèƒ½</strong>ï¼šè°ƒç”¨é˜¿é‡Œäº‘DashScopeçš„å¤šæ¨¡æ€åµŒå…¥æ¨¡å‹ï¼Œå°†æ–‡æœ¬è½¬æ¢ä¸ºå‘é‡</li>
                    <li><strong>å‚æ•°</strong>ï¼š
                        <ul>
                            <li><span class="var-name">text</span>ï¼šç”¨æˆ·è¾“å…¥çš„æŸ¥è¯¢æ–‡æœ¬</li>
                        </ul>
                    </li>
                    <li><strong>è¿”å›å€¼</strong>ï¼šä¸€ä¸ªæµ®ç‚¹æ•°åˆ—è¡¨ï¼Œè¡¨ç¤ºæ–‡æœ¬çš„å‘é‡è¡¨ç¤ºï¼ˆé€šå¸¸å‡ ç™¾åˆ°å‡ åƒç»´ï¼‰</li>
                    <li><strong>å·¥ä½œåŸç†</strong>ï¼šä½¿ç”¨"tongyi-embedding-vision-plus"æ¨¡å‹ï¼Œè¯¥æ¨¡å‹æ”¯æŒæ–‡æœ¬ã€å›¾ç‰‡ã€è§†é¢‘çš„ç»Ÿä¸€å‘é‡åŒ–</li>
                </ul>
            </div>
            
            <!-- distance_to_similarity -->
            <div class="function-box">
                <h4>3. distance_to_similarity(distance) - è·ç¦»è½¬ç›¸ä¼¼åº¦</h4>
                <div class="code-block">
<span class="line-num">57-59</span>def distance_to_similarity(distance):
    """L2è·ç¦»è½¬ç›¸ä¼¼åº¦ (0-1ä¹‹é—´ï¼Œè¶Šå¤§è¶Šç›¸ä¼¼)"""
    return 1 / (1 + distance)
                </div>
                <ul>
                    <li><strong>åŠŸèƒ½</strong>ï¼šå°†L2æ¬§æ°è·ç¦»è½¬æ¢ä¸ºç›¸ä¼¼åº¦åˆ†æ•°ï¼ˆ0-1ä¹‹é—´ï¼‰</li>
                    <li><strong>å…¬å¼</strong>ï¼šç›¸ä¼¼åº¦ = 1 / (1 + è·ç¦»)</li>
                    <li><strong>ç‰¹ç‚¹</strong>ï¼š
                        <ul>
                            <li>è·ç¦»è¶Šå° â†’ ç›¸ä¼¼åº¦è¶Šå¤§ï¼ˆè¶Šæ¥è¿‘1ï¼‰</li>
                            <li>è·ç¦»è¶Šå¤§ â†’ ç›¸ä¼¼åº¦è¶Šå°ï¼ˆè¶Šæ¥è¿‘0ï¼‰</li>
                            <li>è·ç¦»ä¸º0æ—¶ï¼Œç›¸ä¼¼åº¦ä¸º1ï¼ˆå®Œå…¨ç›¸åŒï¼‰</li>
                        </ul>
                    </li>
                    <li><strong>ç¤ºä¾‹</strong>ï¼š
                        <ul>
                            <li>è·ç¦»=0.5 â†’ ç›¸ä¼¼åº¦=0.667</li>
                            <li>è·ç¦»=1.0 â†’ ç›¸ä¼¼åº¦=0.5</li>
                            <li>è·ç¦»=3.0 â†’ ç›¸ä¼¼åº¦=0.25</li>
                        </ul>
                    </li>
                </ul>
            </div>
            
            <!-- detect_media_intent -->
            <div class="function-box">
                <h4>4. detect_media_intent(query) - æ£€æµ‹åª’ä½“æ„å›¾</h4>
                <div class="code-block">
<span class="line-num">62-67</span>def detect_media_intent(query):
    """æ£€æµ‹queryä¸­æ˜¯å¦åŒ…å«å›¾ç‰‡/è§†é¢‘æ„å›¾"""
    query_lower = query.lower()
    want_image = any(kw in query_lower for kw in IMAGE_KEYWORDS)
    want_video = any(kw in query_lower for kw in VIDEO_KEYWORDS)
    return want_image, want_video
                </div>
                <ul>
                    <li><strong>åŠŸèƒ½</strong>ï¼šé€šè¿‡å…³é”®è¯åŒ¹é…æ£€æµ‹ç”¨æˆ·æ˜¯å¦æƒ³è¦å›¾ç‰‡æˆ–è§†é¢‘</li>
                    <li><strong>å‚æ•°</strong>ï¼š
                        <ul>
                            <li><span class="var-name">query</span>ï¼šç”¨æˆ·æŸ¥è¯¢æ–‡æœ¬</li>
                        </ul>
                    </li>
                    <li><strong>è¿”å›å€¼</strong>ï¼š
                        <ul>
                            <li><span class="var-name">want_image</span>ï¼šå¸ƒå°”å€¼ï¼Œæ˜¯å¦éœ€è¦å›¾ç‰‡</li>
                            <li><span class="var-name">want_video</span>ï¼šå¸ƒå°”å€¼ï¼Œæ˜¯å¦éœ€è¦è§†é¢‘</li>
                        </ul>
                    </li>
                    <li><strong>æ£€æµ‹é€»è¾‘</strong>ï¼š
                        <ul>
                            <li>å°†æŸ¥è¯¢è½¬ä¸ºå°å†™</li>
                            <li>æ£€æŸ¥æ˜¯å¦åŒ…å«å›¾ç‰‡å…³é”®è¯ï¼ˆå›¾ç‰‡ã€æµ·æŠ¥ã€ç…§ç‰‡ç­‰ï¼‰</li>
                            <li>æ£€æŸ¥æ˜¯å¦åŒ…å«è§†é¢‘å…³é”®è¯ï¼ˆè§†é¢‘ã€å½•åƒã€å½±ç‰‡ç­‰ï¼‰</li>
                        </ul>
                    </li>
                    <li><strong>ç¤ºä¾‹</strong>ï¼š
                        <ul>
                            <li>"çœ‹çœ‹ä¸‡åœ£èŠ‚æµ·æŠ¥" â†’ want_image=True, want_video=False</li>
                            <li>"æ’­æ”¾ä¸€ä¸‹è§†é¢‘" â†’ want_image=False, want_video=True</li>
                        </ul>
                    </li>
                </ul>
            </div>
            
            <!-- search_with_details -->
            <div class="function-box">
                <h4>5. search_with_details(query, index, metadata) - æ£€ç´¢å¹¶æ‰“å°è¯¦æƒ…</h4>
                <div class="code-block">
<span class="line-num">70-104</span>def search_with_details(query, index, metadata):
    """æ£€ç´¢å¹¶æ‰“å°ç›¸ä¼¼åº¦è¯¦æƒ…"""
    # è·å–æŸ¥è¯¢å‘é‡
    query_vec = np.array([get_text_embedding(query)]).astype('float32')
    
    # æ£€ç´¢æ‰€æœ‰ç»“æœ
    distances, indices = index.search(query_vec, index.ntotal)
    
    # æ„å»ºç»“æœåˆ—è¡¨
    results = []
    for rank, (idx, dist) in enumerate(zip(indices[0], distances[0])):
        if idx == -1:
            continue
        m = metadata[idx]
        sim = distance_to_similarity(dist)
        results.append({"idx": idx, "distance": dist, "similarity": sim, "metadata": m})
    
    return results
                </div>
                <ul>
                    <li><strong>åŠŸèƒ½</strong>ï¼šæ‰§è¡Œå‘é‡æ£€ç´¢ï¼Œè¿”å›æ‰€æœ‰ç»“æœçš„è¯¦ç»†ä¿¡æ¯</li>
                    <li><strong>å‚æ•°</strong>ï¼š
                        <ul>
                            <li><span class="var-name">query</span>ï¼šç”¨æˆ·æŸ¥è¯¢æ–‡æœ¬</li>
                            <li><span class="var-name">index</span>ï¼šFAISSç´¢å¼•å¯¹è±¡</li>
                            <li><span class="var-name">metadata</span>ï¼šå…ƒæ•°æ®åˆ—è¡¨</li>
                        </ul>
                    </li>
                    <li><strong>å…³é”®å˜é‡</strong>ï¼š
                        <ul>
                            <li><span class="var-name">query_vec</span>ï¼šæŸ¥è¯¢æ–‡æœ¬çš„å‘é‡è¡¨ç¤ºï¼ˆnumpyæ•°ç»„ï¼Œshape: [1, embedding_dim]ï¼‰</li>
                            <li><span class="var-name">distances</span>ï¼šæ‰€æœ‰ç»“æœä¸æŸ¥è¯¢çš„L2è·ç¦»ï¼ˆå·²æ’åºï¼Œä»å°åˆ°å¤§ï¼‰</li>
                            <li><span class="var-name">indices</span>ï¼šå¯¹åº”çš„å…ƒæ•°æ®ç´¢å¼•IDï¼ˆå·²æ’åºï¼ŒæŒ‰è·ç¦»ï¼‰</li>
                            <li><span class="var-name">results</span>ï¼šç»“æœåˆ—è¡¨ï¼Œæ¯ä¸ªå…ƒç´ åŒ…å«ï¼š
                                <div class="data-structure">
{
    "idx": ç´¢å¼•ID,
    "distance": L2è·ç¦»,
    "similarity": ç›¸ä¼¼åº¦åˆ†æ•°,
    "metadata": {
        "type": "text/image/video",
        "content": "å†…å®¹æ–‡æœ¬",
        "source": "æ¥æº",
        "path": "å›¾ç‰‡è·¯å¾„ï¼ˆå¦‚æœæ˜¯å›¾ç‰‡ï¼‰",
        "url": "è§†é¢‘URLï¼ˆå¦‚æœæ˜¯è§†é¢‘ï¼‰"
    }
}
                                </div>
                            </li>
                        </ul>
                    </li>
                    <li><strong>å·¥ä½œæµç¨‹</strong>ï¼š
                        <ol>
                            <li>å°†æŸ¥è¯¢æ–‡æœ¬è½¬æ¢ä¸ºå‘é‡</li>
                            <li>åœ¨FAISSç´¢å¼•ä¸­æœç´¢æ‰€æœ‰ç›¸ä¼¼å‘é‡ï¼ˆè¿”å›æ‰€æœ‰ç»“æœï¼‰</li>
                            <li>å¯¹æ¯ä¸ªç»“æœè®¡ç®—ç›¸ä¼¼åº¦å¹¶æ„å»ºç»“æœå­—å…¸</li>
                            <li>æ‰“å°æ’åè¡¨æ ¼ï¼ˆåŒ…å«æ’åã€IDã€ç±»å‹ã€ç›¸ä¼¼åº¦ã€è·ç¦»ã€å†…å®¹é¢„è§ˆï¼‰</li>
                        </ol>
                    </li>
                </ul>
            </div>
            
            <!-- rag_ask -->
            <div class="function-box">
                <h4>6. rag_ask(query, index, metadata, k=3) - RAGé—®ç­”ä¸»å‡½æ•°</h4>
                <div class="code-block">
<span class="line-num">107-174</span>def rag_ask(query, index, metadata, k=3):
    """RAGé—®ç­”ï¼Œæ”¯æŒå›¾ç‰‡/è§†é¢‘å…³é”®è¯æ£€æµ‹"""
    # 1. æ£€ç´¢æ‰€æœ‰ç»“æœ
    results = search_with_details(query, index, metadata)
    
    # 2. æ£€æµ‹åª’ä½“æ„å›¾
    want_image, want_video = detect_media_intent(query)
    
    # 3. é€‰æ‹©Top-Kæ–‡æœ¬ç»“æœ
    top_results = [r for r in results if r["metadata"]["type"] == "text"][:k]
    
    # 4. åŒ¹é…å›¾ç‰‡ï¼ˆå¦‚æœéœ€è¦ï¼‰
    matched_image = None
    if want_image:
        image_results = [r for r in results if r["metadata"]["type"] == "image" 
                         and r["distance"] < MEDIA_DISTANCE_THRESHOLD]
        if image_results:
            image_results.sort(key=lambda x: x["distance"])
            matched_image = image_results[0]
    
    # 5. åŒ¹é…è§†é¢‘ï¼ˆå¦‚æœéœ€è¦ï¼‰
    matched_video = None
    if want_video:
        video_results = [r for r in results if r["metadata"]["type"] == "video" 
                         and r["distance"] < MEDIA_DISTANCE_THRESHOLD]
        if video_results:
            video_results.sort(key=lambda x: x["distance"])
            matched_video = video_results[0]
    
    # 6. æ„å»ºPrompt
    context_str = ""
    for i, r in enumerate(top_results):
        m = r["metadata"]
        context_str += f"èƒŒæ™¯çŸ¥è¯† {i+1} (æ¥æº: {m['source']}, ç›¸ä¼¼åº¦: {r['similarity']:.4f}):\n{m['content']}\n\n"
    
    prompt = f"""ä½ æ˜¯ä¸€ä¸ªè¿ªå£«å°¼å®¢æœåŠ©æ‰‹ã€‚è¯·æ ¹æ®ä»¥ä¸‹èƒŒæ™¯çŸ¥è¯†å›ç­”ç”¨æˆ·é—®é¢˜ã€‚

[èƒŒæ™¯çŸ¥è¯†]
{context_str}
[ç”¨æˆ·é—®é¢˜]
{query}
"""
    
    # 7. è°ƒç”¨LLMç”Ÿæˆç­”æ¡ˆ
    completion = client.chat.completions.create(
        model="qwen-flash",
        messages=[
            {"role": "system", "content": "ä½ æ˜¯ä¸€ä¸ªè¿ªå£«å°¼å®¢æœåŠ©æ‰‹ã€‚"},
            {"role": "user", "content": prompt}
        ]
    )
    answer = completion.choices[0].message.content
    
    # 8. é™„åŠ åª’ä½“ä¿¡æ¯
    if matched_image:
        answer += f"\n\n[ç›¸å…³å›¾ç‰‡]: {matched_image['metadata']['path']}"
    if matched_video:
        answer += f"\n\n[ç›¸å…³è§†é¢‘]: {matched_video['metadata']['url']}"
    
    return answer
                </div>
                <ul>
                    <li><strong>åŠŸèƒ½</strong>ï¼šRAGé—®ç­”çš„æ ¸å¿ƒå‡½æ•°ï¼Œæ•´åˆæ£€ç´¢ã€æ„å›¾æ£€æµ‹ã€LLMç”Ÿæˆ</li>
                    <li><strong>å‚æ•°</strong>ï¼š
                        <ul>
                            <li><span class="var-name">query</span>ï¼šç”¨æˆ·æŸ¥è¯¢</li>
                            <li><span class="var-name">index</span>ï¼šFAISSç´¢å¼•</li>
                            <li><span class="var-name">metadata</span>ï¼šå…ƒæ•°æ®</li>
                            <li><span class="var-name">k</span>ï¼šé»˜è®¤3ï¼Œé€‰æ‹©Top-Kä¸ªæ–‡æœ¬ç»“æœç”¨äºæ„å»ºä¸Šä¸‹æ–‡</li>
                        </ul>
                    </li>
                    <li><strong>è¯¦ç»†æµç¨‹</strong>ï¼š
                        <ol>
                            <li><strong>æ£€ç´¢é˜¶æ®µ</strong>ï¼šè°ƒç”¨search_with_detailsè·å–æ‰€æœ‰ç›¸ä¼¼ç»“æœ</li>
                            <li><strong>æ„å›¾æ£€æµ‹</strong>ï¼šæ£€æµ‹æ˜¯å¦éœ€è¦å›¾ç‰‡/è§†é¢‘</li>
                            <li><strong>æ–‡æœ¬ç­›é€‰</strong>ï¼šä»ç»“æœä¸­ç­›é€‰type="text"çš„è®°å½•ï¼Œå–å‰kä¸ª</li>
                            <li><strong>å›¾ç‰‡åŒ¹é…</strong>ï¼š
                                <ul>
                                    <li>å¦‚æœwant_image=Trueï¼Œç­›é€‰type="image"ä¸”distance&lt;3.0çš„ç»“æœ</li>
                                    <li>æŒ‰è·ç¦»æ’åºï¼Œå–è·ç¦»æœ€å°çš„Top1</li>
                                </ul>
                            </li>
                            <li><strong>è§†é¢‘åŒ¹é…</strong>ï¼šåŒå›¾ç‰‡åŒ¹é…é€»è¾‘</li>
                            <li><strong>æ„å»ºä¸Šä¸‹æ–‡</strong>ï¼šå°†Top-Kæ–‡æœ¬ç»“æœæ ¼å¼åŒ–ä¸ºèƒŒæ™¯çŸ¥è¯†å­—ç¬¦ä¸²</li>
                            <li><strong>LLMç”Ÿæˆ</strong>ï¼šè°ƒç”¨qwen-flashæ¨¡å‹ç”Ÿæˆç­”æ¡ˆ</li>
                            <li><strong>é™„åŠ åª’ä½“</strong>ï¼šå¦‚æœæœ‰åŒ¹é…çš„å›¾ç‰‡/è§†é¢‘ï¼Œè¿½åŠ åˆ°ç­”æ¡ˆæœ«å°¾</li>
                        </ol>
                    </li>
                    <li><strong>å…³é”®å˜é‡</strong>ï¼š
                        <ul>
                            <li><span class="var-name">top_results</span>ï¼šTop-Kæ–‡æœ¬ç»“æœåˆ—è¡¨</li>
                            <li><span class="var-name">matched_image</span>ï¼šåŒ¹é…åˆ°çš„å›¾ç‰‡ç»“æœï¼ˆå¯èƒ½ä¸ºNoneï¼‰</li>
                            <li><span class="var-name">matched_video</span>ï¼šåŒ¹é…åˆ°çš„è§†é¢‘ç»“æœï¼ˆå¯èƒ½ä¸ºNoneï¼‰</li>
                            <li><span class="var-name">context_str</span>ï¼šæ ¼å¼åŒ–çš„èƒŒæ™¯çŸ¥è¯†å­—ç¬¦ä¸²</li>
                            <li><span class="var-name">prompt</strong>ï¼šå‘é€ç»™LLMçš„å®Œæ•´æç¤ºè¯</li>
                            <li><span class="var-name">answer</span>ï¼šLLMç”Ÿæˆçš„æœ€ç»ˆç­”æ¡ˆ</li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
        
        <!-- æ•°æ®ç»“æ„è¯´æ˜ -->
        <div class="section">
            <h2>ğŸ“¦ æ•°æ®ç»“æ„è¯´æ˜</h2>
            
            <h3>1. metadata å…ƒæ•°æ®ç»“æ„</h3>
            <div class="code-block">
{
    "type": "text" | "image" | "video",  // æ•°æ®ç±»å‹
    "content": "æ–‡æœ¬å†…å®¹",                 // æ–‡æœ¬å†…å®¹æˆ–æè¿°
    "source": "æ¥æºæ–‡ä»¶/URL",              // æ•°æ®æ¥æº
    "path": "å›¾ç‰‡è·¯å¾„",                    // ä»…å›¾ç‰‡ç±»å‹æœ‰
    "url": "è§†é¢‘URL"                      // ä»…è§†é¢‘ç±»å‹æœ‰
}
            </div>
            
            <h3>2. results ç»“æœç»“æ„</h3>
            <div class="code-block">
[
    {
        "idx": 0,                        // å…ƒæ•°æ®ç´¢å¼•ID
        "distance": 0.5234,              // L2è·ç¦»ï¼ˆè¶Šå°è¶Šç›¸ä¼¼ï¼‰
        "similarity": 0.6567,            // ç›¸ä¼¼åº¦åˆ†æ•°ï¼ˆ0-1ï¼Œè¶Šå¤§è¶Šç›¸ä¼¼ï¼‰
        "metadata": { ... }              // å¯¹åº”çš„å…ƒæ•°æ®å¯¹è±¡
    },
    ...
]
            </div>
            
            <h3>3. Prompt ç»“æ„</h3>
            <div class="code-block">
ä½ æ˜¯ä¸€ä¸ªè¿ªå£«å°¼å®¢æœåŠ©æ‰‹ã€‚è¯·æ ¹æ®ä»¥ä¸‹èƒŒæ™¯çŸ¥è¯†å›ç­”ç”¨æˆ·é—®é¢˜ã€‚

[èƒŒæ™¯çŸ¥è¯†]
èƒŒæ™¯çŸ¥è¯† 1 (æ¥æº: xxx, ç›¸ä¼¼åº¦: 0.8234):
å†…å®¹1...

èƒŒæ™¯çŸ¥è¯† 2 (æ¥æº: yyy, ç›¸ä¼¼åº¦: 0.7123):
å†…å®¹2...

[ç”¨æˆ·é—®é¢˜]
ç”¨æˆ·æŸ¥è¯¢æ–‡æœ¬
            </div>
        </div>
        
        <!-- å…³é”®æµç¨‹è¯´æ˜ -->
        <div class="section">
            <h2>ğŸ”„ å…³é”®æµç¨‹è¯´æ˜</h2>
            
            <div class="flow-step">
                <h4>æ­¥éª¤1ï¼šåˆå§‹åŒ–</h4>
                <p>ç¨‹åºå¯åŠ¨æ—¶ï¼Œè°ƒç”¨<code>load_index()</code>åŠ è½½FAISSç´¢å¼•å’Œå…ƒæ•°æ®JSONæ–‡ä»¶åˆ°å†…å­˜ã€‚</p>
            </div>
            
            <div class="flow-step">
                <h4>æ­¥éª¤2ï¼šç”¨æˆ·æŸ¥è¯¢</h4>
                <p>ç”¨æˆ·è¾“å…¥æŸ¥è¯¢æ–‡æœ¬ï¼Œä¾‹å¦‚ï¼š"æˆ‘æƒ³äº†è§£ä¸€ä¸‹è¿ªå£«å°¼é—¨ç¥¨çš„é€€æ¬¾æµç¨‹"</p>
            </div>
            
            <div class="flow-step">
                <h4>æ­¥éª¤3ï¼šå‘é‡åŒ–</h4>
                <p>è°ƒç”¨<code>get_text_embedding()</code>å°†æŸ¥è¯¢æ–‡æœ¬è½¬æ¢ä¸ºé«˜ç»´å‘é‡ï¼ˆä¾‹å¦‚768ç»´æˆ–1536ç»´ï¼‰ã€‚</p>
            </div>
            
            <div class="flow-step">
                <h4>æ­¥éª¤4ï¼šå‘é‡æ£€ç´¢</h4>
                <p>ä½¿ç”¨FAISSç´¢å¼•çš„<code>search()</code>æ–¹æ³•ï¼Œåœ¨ç´¢å¼•ä¸­æœç´¢ä¸æŸ¥è¯¢å‘é‡æœ€ç›¸ä¼¼çš„æ‰€æœ‰å‘é‡ï¼Œè¿”å›è·ç¦»å’Œç´¢å¼•IDã€‚</p>
                <div class="note">
                    <strong>æ³¨æ„</strong>ï¼šFAISSä½¿ç”¨L2è·ç¦»ï¼ˆæ¬§æ°è·ç¦»ï¼‰è®¡ç®—ç›¸ä¼¼åº¦ï¼Œè·ç¦»è¶Šå°è¡¨ç¤ºè¶Šç›¸ä¼¼ã€‚
                </div>
            </div>
            
            <div class="flow-step">
                <h4>æ­¥éª¤5ï¼šç»“æœå¤„ç†</h4>
                <p>å¯¹æ¯ä¸ªæ£€ç´¢ç»“æœï¼š
                <ul>
                    <li>é€šè¿‡ç´¢å¼•IDä»metadataä¸­è·å–å®Œæ•´ä¿¡æ¯</li>
                    <li>å°†è·ç¦»è½¬æ¢ä¸ºç›¸ä¼¼åº¦åˆ†æ•°ï¼ˆ0-1ä¹‹é—´ï¼‰</li>
                    <li>æ„å»ºç»“æœå­—å…¸å¹¶æ‰“å°æ’åè¡¨æ ¼</li>
                </ul>
                </p>
            </div>
            
            <div class="flow-step">
                <h4>æ­¥éª¤6ï¼šæ„å›¾æ£€æµ‹</h4>
                <p>è°ƒç”¨<code>detect_media_intent()</code>æ£€æµ‹ç”¨æˆ·æ˜¯å¦æƒ³è¦å›¾ç‰‡æˆ–è§†é¢‘ï¼š
                <ul>
                    <li>æ£€æŸ¥æŸ¥è¯¢ä¸­æ˜¯å¦åŒ…å«å›¾ç‰‡å…³é”®è¯ï¼ˆå›¾ç‰‡ã€æµ·æŠ¥ã€ç…§ç‰‡ç­‰ï¼‰</li>
                    <li>æ£€æŸ¥æŸ¥è¯¢ä¸­æ˜¯å¦åŒ…å«è§†é¢‘å…³é”®è¯ï¼ˆè§†é¢‘ã€å½•åƒã€å½±ç‰‡ç­‰ï¼‰</li>
                </ul>
                </p>
            </div>
            
            <div class="flow-step">
                <h4>æ­¥éª¤7ï¼šç»“æœç­›é€‰</h4>
                <p>
                <ul>
                    <li><strong>æ–‡æœ¬ç»“æœ</strong>ï¼šç­›é€‰type="text"çš„è®°å½•ï¼Œå–å‰kä¸ªï¼ˆé»˜è®¤k=3ï¼‰</li>
                    <li><strong>å›¾ç‰‡ç»“æœ</strong>ï¼šå¦‚æœwant_image=Trueï¼Œç­›é€‰type="image"ä¸”distance&lt;3.0çš„è®°å½•ï¼ŒæŒ‰è·ç¦»æ’åºå–Top1</li>
                    <li><strong>è§†é¢‘ç»“æœ</strong>ï¼šå¦‚æœwant_video=Trueï¼Œç­›é€‰type="video"ä¸”distance&lt;3.0çš„è®°å½•ï¼ŒæŒ‰è·ç¦»æ’åºå–Top1</li>
                </ul>
                </p>
                <div class="warning">
                    <strong>é‡è¦</strong>ï¼šå›¾ç‰‡/è§†é¢‘åŒ¹é…æœ‰è·ç¦»é˜ˆå€¼é™åˆ¶ï¼ˆMEDIA_DISTANCE_THRESHOLD=3.0ï¼‰ï¼Œåªæœ‰è·ç¦»å°äº3.0çš„æ‰ä¼šè¢«åŒ¹é…ã€‚
                </div>
            </div>
            
            <div class="flow-step">
                <h4>æ­¥éª¤8ï¼šæ„å»ºPrompt</h4>
                <p>å°†Top-Kæ–‡æœ¬ç»“æœæ ¼å¼åŒ–ä¸ºèƒŒæ™¯çŸ¥è¯†å­—ç¬¦ä¸²ï¼ŒåŒ…å«ï¼š
                <ul>
                    <li>æ¥æºä¿¡æ¯</li>
                    <li>ç›¸ä¼¼åº¦åˆ†æ•°</li>
                    <li>å®Œæ•´å†…å®¹</li>
                </ul>
                ç„¶åä¸ç”¨æˆ·æŸ¥è¯¢ä¸€èµ·æ„å»ºæˆå®Œæ•´çš„Promptã€‚
                </p>
            </div>
            
            <div class="flow-step">
                <h4>æ­¥éª¤9ï¼šLLMç”Ÿæˆ</h4>
                <p>è°ƒç”¨é˜¿é‡Œäº‘DashScopeçš„qwen-flashæ¨¡å‹ï¼Œä¼ å…¥ï¼š
                <ul>
                    <li>Systemæ¶ˆæ¯ï¼šå®šä¹‰è§’è‰²ä¸º"è¿ªå£«å°¼å®¢æœåŠ©æ‰‹"</li>
                    <li>Useræ¶ˆæ¯ï¼šåŒ…å«èƒŒæ™¯çŸ¥è¯†å’Œç”¨æˆ·é—®é¢˜çš„å®Œæ•´Prompt</li>
                </ul>
                LLMåŸºäºä¸Šä¸‹æ–‡ç”Ÿæˆç­”æ¡ˆã€‚
                </p>
            </div>
            
            <div class="flow-step">
                <h4>æ­¥éª¤10ï¼šé™„åŠ åª’ä½“</h4>
                <p>å¦‚æœåŒ¹é…åˆ°äº†å›¾ç‰‡æˆ–è§†é¢‘ï¼Œå°†å¯¹åº”çš„è·¯å¾„/URLè¿½åŠ åˆ°ç­”æ¡ˆæœ«å°¾ï¼Œæ ¼å¼ä¸ºï¼š
                <ul>
                    <li><code>[ç›¸å…³å›¾ç‰‡]: å›¾ç‰‡è·¯å¾„</code></li>
                    <li><code>[ç›¸å…³è§†é¢‘]: è§†é¢‘URL</code></li>
                </ul>
                </p>
            </div>
        </div>
        
        <!-- å®Œæ•´ä»£ç  -->
        <div class="section">
            <h2>ğŸ“„ å®Œæ•´ä»£ç </h2>
            <div class="code-block">
# -*- coding: utf-8 -*-
"""
è¿ªå£«å°¼RAGåŠ©æ‰‹ V2 - æŸ¥è¯¢å¤„ç†

åŠŸèƒ½ï¼šåŠ è½½ç´¢å¼•ï¼Œå¤„ç†ç”¨æˆ·queryï¼Œæ‰“å°ç›¸ä¼¼åº¦æ’åï¼Œæ”¯æŒå›¾ç‰‡/è§†é¢‘å…³é”®è¯æ£€æµ‹
"""
import os
import json
import numpy as np
import faiss
import dashscope
from http import HTTPStatus
from openai import OpenAI

# é…ç½®
DASHSCOPE_API_KEY = os.getenv("DASHSCOPE_API_KEY")
if not DASHSCOPE_API_KEY:
    raise ValueError("é”™è¯¯ï¼šè¯·è®¾ç½® 'DASHSCOPE_API_KEY' ç¯å¢ƒå˜é‡ã€‚")

dashscope.api_key = DASHSCOPE_API_KEY

client = OpenAI(
    api_key=DASHSCOPE_API_KEY,
    base_url="https://dashscope.aliyuncs.com/compatible-mode/v1"
)

MULTIMODAL_EMBEDDING_MODEL = "tongyi-embedding-vision-plus"
INDEX_FILE = "disney_index.faiss"
METADATA_FILE = "disney_metadata.json"

# å…³é”®è¯é…ç½®
IMAGE_KEYWORDS = ["å›¾ç‰‡", "æµ·æŠ¥", "ç…§ç‰‡", "çœ‹çœ‹", "é•¿ä»€ä¹ˆæ ·", "å›¾"]
VIDEO_KEYWORDS = ["è§†é¢‘", "å½•åƒ", "å½±ç‰‡", "çœ‹ä¸€ä¸‹", "æ’­æ”¾"]
MEDIA_DISTANCE_THRESHOLD = 3.0  # å›¾ç‰‡/è§†é¢‘åŒ¹é…çš„è·ç¦»é˜ˆå€¼


def load_index():
    """åŠ è½½ç´¢å¼•å’Œå…ƒæ•°æ®"""
    index = faiss.read_index(INDEX_FILE)
    with open(METADATA_FILE, 'r', encoding='utf-8') as f:
        metadata = json.load(f)
    print(f"å·²åŠ è½½ç´¢å¼•: {index.ntotal} æ¡è®°å½•")
    return index, metadata


def get_text_embedding(text):
    """æ–‡æœ¬embedding"""
    resp = dashscope.MultiModalEmbedding.call(
        model=MULTIMODAL_EMBEDDING_MODEL,
        input=[{'text': text}]
    )
    if resp.status_code != HTTPStatus.OK:
        raise Exception(f"Embeddingå¤±è´¥: {resp.message}")
    return resp.output['embeddings'][0]['embedding']


def distance_to_similarity(distance):
    """L2è·ç¦»è½¬ç›¸ä¼¼åº¦ (0-1ä¹‹é—´ï¼Œè¶Šå¤§è¶Šç›¸ä¼¼)"""
    return 1 / (1 + distance)


def detect_media_intent(query):
    """æ£€æµ‹queryä¸­æ˜¯å¦åŒ…å«å›¾ç‰‡/è§†é¢‘æ„å›¾"""
    query_lower = query.lower()
    want_image = any(kw in query_lower for kw in IMAGE_KEYWORDS)
    want_video = any(kw in query_lower for kw in VIDEO_KEYWORDS)
    return want_image, want_video


def search_with_details(query, index, metadata):
    """æ£€ç´¢å¹¶æ‰“å°ç›¸ä¼¼åº¦è¯¦æƒ…"""
    print(f"\n{'='*60}")
    print(f"Query: {query}")
    print('='*60)

    query_vec = np.array([get_text_embedding(query)]).astype('float32')

    # æ£€ç´¢æ‰€æœ‰
    distances, indices = index.search(query_vec, index.ntotal) # ç›¸ä¼¼åº¦ï¼Œä¸‹æ ‡

    print(f"\nç›¸ä¼¼åº¦æ’å (è¶Šå¤§è¶Šç›¸ä¼¼):")
    print("-" * 80)
    print(f"{'æ’å':4s} {'ID':4s} {'ç±»å‹':6s} {'ç›¸ä¼¼åº¦':8s} {'è·ç¦»':8s} å†…å®¹")
    print("-" * 80)

    results = []
    for rank, (idx, dist) in enumerate(zip(indices[0], distances[0])):
        if idx == -1:
            continue
        m = metadata[idx]
        sim = distance_to_similarity(dist)
        content_preview = m['content'][:45].replace('\n', ' ')
        type_tag = m['type']

        marker = ""
        if type_tag == "image":
            marker = " <-- å›¾ç‰‡"
        elif type_tag == "video":
            marker = " <-- è§†é¢‘"

        print(f"{rank+1:4d} {idx:4d} [{type_tag:5s}] {sim:6.4f}  {dist:8.4f}  {content_preview}...{marker}")
        results.append({"idx": idx, "distance": dist, "similarity": sim, "metadata": m})

    return results


def rag_ask(query, index, metadata, k=3):
    """RAGé—®ç­”ï¼Œæ”¯æŒå›¾ç‰‡/è§†é¢‘å…³é”®è¯æ£€æµ‹"""
    results = search_with_details(query, index, metadata)

    # æ£€æµ‹åª’ä½“æ„å›¾
    want_image, want_video = detect_media_intent(query)
    print(f"\næ„å›¾æ£€æµ‹: éœ€è¦å›¾ç‰‡={want_image}, éœ€è¦è§†é¢‘={want_video}")

    # å–top-kæ–‡æœ¬ç»“æœ
    top_results = [r for r in results if r["metadata"]["type"] == "text"][:k]

    # å¦‚æœéœ€è¦å›¾ç‰‡ï¼Œæ‰¾è·ç¦»<3çš„å›¾ç‰‡ä¸­è·ç¦»æœ€å°çš„Top1
    matched_image = None
    if want_image:
        image_results = [r for r in results if r["metadata"]["type"] == "image" and r["distance"] < MEDIA_DISTANCE_THRESHOLD]
        if image_results:
            # æŒ‰è·ç¦»æ’åºï¼Œå–è·ç¦»æœ€å°çš„Top1
            image_results.sort(key=lambda x: x["distance"])
            matched_image = image_results[0]
            print(f"  -> åŒ¹é…åˆ°å›¾ç‰‡: {matched_image['metadata']['path']} (è·ç¦»: {matched_image['distance']:.4f}, ç›¸ä¼¼åº¦: {matched_image['similarity']:.4f})")

    # å¦‚æœéœ€è¦è§†é¢‘ï¼Œæ‰¾è·ç¦»<3çš„è§†é¢‘ä¸­è·ç¦»æœ€å°çš„Top1
    matched_video = None
    if want_video:
        video_results = [r for r in results if r["metadata"]["type"] == "video" and r["distance"] < MEDIA_DISTANCE_THRESHOLD]
        if video_results:
            # æŒ‰è·ç¦»æ’åºï¼Œå–è·ç¦»æœ€å°çš„Top1
            video_results.sort(key=lambda x: x["distance"])
            matched_video = video_results[0]
            print(f"  -> åŒ¹é…åˆ°è§†é¢‘: {matched_video['metadata']['url']} (è·ç¦»: {matched_video['distance']:.4f}, ç›¸ä¼¼åº¦: {matched_video['similarity']:.4f})")

    print(f"\né€‰å–Top-{k}æ–‡æœ¬æ„å»ºPrompt:")
    for r in top_results:
        print(f"  - {r['metadata']['content'][:50]}... (ç›¸ä¼¼åº¦: {r['similarity']:.4f})")

    # æ„å»ºcontext
    context_str = ""
    for i, r in enumerate(top_results):
        m = r["metadata"]
        context_str += f"èƒŒæ™¯çŸ¥è¯† {i+1} (æ¥æº: {m['source']}, ç›¸ä¼¼åº¦: {r['similarity']:.4f}):\n{m['content']}\n\n"

    prompt = f"""ä½ æ˜¯ä¸€ä¸ªè¿ªå£«å°¼å®¢æœåŠ©æ‰‹ã€‚è¯·æ ¹æ®ä»¥ä¸‹èƒŒæ™¯çŸ¥è¯†å›ç­”ç”¨æˆ·é—®é¢˜ã€‚

[èƒŒæ™¯çŸ¥è¯†]
{context_str}
[ç”¨æˆ·é—®é¢˜]
{query}
"""

    # è°ƒç”¨LLM
    print("\nè°ƒç”¨LLMç”Ÿæˆç­”æ¡ˆ...")
    completion = client.chat.completions.create(
        model="qwen-flash",
        messages=[
            {"role": "system", "content": "ä½ æ˜¯ä¸€ä¸ªè¿ªå£«å°¼å®¢æœåŠ©æ‰‹ã€‚"},
            {"role": "user", "content": prompt}
        ]
    )
    answer = completion.choices[0].message.content

    # é™„åŠ åŒ¹é…åˆ°çš„åª’ä½“
    if matched_image:
        answer += f"\n\n[ç›¸å…³å›¾ç‰‡]: {matched_image['metadata']['path']}"
    if matched_video:
        answer += f"\n\n[ç›¸å…³è§†é¢‘]: {matched_video['metadata']['url']}"

    print(f"\næœ€ç»ˆç­”æ¡ˆ:\n{answer}")
    return answer


if __name__ == "__main__":
    index, metadata = load_index()

    print("\n" + "="*60)
    print("æµ‹è¯•1: æ–‡æœ¬æŸ¥è¯¢")
    rag_ask("æˆ‘æƒ³äº†è§£ä¸€ä¸‹è¿ªå£«å°¼é—¨ç¥¨çš„é€€æ¬¾æµç¨‹", index, metadata, k=3)

    # print("\n" + "="*60)
    # print("æµ‹è¯•2: å›¾ç‰‡æŸ¥è¯¢ - ä¸‡åœ£èŠ‚æµ·æŠ¥")
    # rag_ask("æœ€è¿‘ä¸‡åœ£èŠ‚çš„æ´»åŠ¨æµ·æŠ¥æ˜¯ä»€ä¹ˆ", index, metadata, k=3)
    #
    # print("\n" + "="*60)
    # print("æµ‹è¯•3: è§†é¢‘æŸ¥è¯¢ - æ±½è½¦å‰è¹­")
    # rag_ask("æˆ‘çš„æ±½è½¦è¢«å‰è¹­äº†ï¼Œä½ èƒ½çœ‹åˆ°è§†é¢‘ä¹ˆï¼Ÿ", index, metadata, k=3)
    #
    # print("\n" + "="*60)
    # print("æµ‹è¯•4: å›¾ç‰‡æŸ¥è¯¢ - èšåœ¨ä¸€èµ·")
    # rag_ask("èšåœ¨ä¸€èµ·è¯´å¥‡å¦™çš„æµ·æŠ¥", index, metadata, k=3)
            </div>
        </div>
        
        <!-- æ€»ç»“ -->
        <div class="section">
            <h2>ğŸ’¡ æ€»ç»“</h2>
            <div class="note">
                <h3>æ ¸å¿ƒç‰¹ç‚¹ï¼š</h3>
                <ul>
                    <li><strong>å¤šæ¨¡æ€æ”¯æŒ</strong>ï¼šæ”¯æŒæ–‡æœ¬ã€å›¾ç‰‡ã€è§†é¢‘çš„ç»Ÿä¸€å‘é‡æ£€ç´¢</li>
                    <li><strong>æ„å›¾æ£€æµ‹</strong>ï¼šé€šè¿‡å…³é”®è¯æ£€æµ‹ç”¨æˆ·æ˜¯å¦éœ€è¦å›¾ç‰‡/è§†é¢‘</li>
                    <li><strong>é˜ˆå€¼è¿‡æ»¤</strong>ï¼šå›¾ç‰‡/è§†é¢‘åŒ¹é…æœ‰è·ç¦»é˜ˆå€¼é™åˆ¶ï¼Œç¡®ä¿è´¨é‡</li>
                    <li><strong>RAGæ¶æ„</strong>ï¼šæ£€ç´¢å¢å¼ºç”Ÿæˆï¼Œç»“åˆå‘é‡æ£€ç´¢å’ŒLLMç”Ÿæˆ</li>
                    <li><strong>è¯¦ç»†æ—¥å¿—</strong>ï¼šæ‰“å°ç›¸ä¼¼åº¦æ’åå’ŒåŒ¹é…è¿‡ç¨‹ï¼Œä¾¿äºè°ƒè¯•</li>
                </ul>
            </div>
            
            <div class="warning">
                <h3>æ³¨æ„äº‹é¡¹ï¼š</h3>
                <ul>
                    <li>éœ€è¦æå‰æ„å»ºFAISSç´¢å¼•å’Œå…ƒæ•°æ®æ–‡ä»¶</li>
                    <li>éœ€è¦è®¾ç½®DASHSCOPE_API_KEYç¯å¢ƒå˜é‡</li>
                    <li>å›¾ç‰‡/è§†é¢‘åŒ¹é…ä¾èµ–å…³é”®è¯æ£€æµ‹ï¼Œå¯èƒ½ä¸å¤Ÿæ™ºèƒ½</li>
                    <li>è·ç¦»é˜ˆå€¼ï¼ˆ3.0ï¼‰å¯èƒ½éœ€è¦æ ¹æ®å®é™…æ•°æ®è°ƒæ•´</li>
                </ul>
            </div>
        </div>
    </div>
    
    <script>
        mermaid.initialize({ startOnLoad: true, theme: 'default' });
    </script>
</body>
</html>
